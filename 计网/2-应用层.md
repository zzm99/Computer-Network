# 应用层

1. 进程通过一个称为套接字socket的软件接口向网络发送报文和从网络接收报文。套接字是同一台主机内应用层与运输层之间的接口。由于该套接字是建立网络应用程序的可编程接口，因此套接字也称为应用程序和网络之间的应用程序编程接口API。
2. 主机由其IP地址标识。接收主机上的接收进程由目的地端口号标识。
3. 应用层协议定义了运行在不同端系统上的应用程序进程如何相互传递报文：
   1. 交换的报文类型。例如请求报文和响应报文。
   2. 各种报文类型的语法，如报文中的各个字段及这些字段是如何描述的。
   3. 字段的语义，即这些字段中的信息的含义。
   4. 确定一个进程何时以及如何发送报文，对报文进行响应的规则。
4. 应用层协议只是网络应用的一部分。
5. Web和HTTP：
   1. Web的应用层协议是超文本传输协议HTTP，它是Web的核心。Web页面（也叫文档）是由对象组成的。一个对象只是一个文件，它们可通过URL地址寻址。Web浏览器实现了HTTP的客户端。Web服务器实现了HTTP的服务器端，它用于存储Web对象，每个对象由URL寻址。HTTP定义了Web客户向Web服务器请求Web页面的方式，以及服务器向客户传送Web页面的方式。
   2. HTTP使用TCP作为它的支撑运输协议而不是UDP。
   3. 服务器向客户发送被请求的文件，而不存储任何关于该客户的状态信息。
   4. HTTP服务器并不保存关于客户的任何信息，所以我们说HTTP是一个无状态协议。Web使用了客户-服务器应用程序体系结构。Web服务器总是打开的，具有一个固定的IP地址，且它服务于可能来自数以百万计的不同浏览器的请求。
   5. 非持续连接：每个请求/响应对是经一个单独的TCP连接发送。每个TCP连接只传输一个请求报文和一个响应报文。
   6. 持续连接：所有的请求及其响应经相同的TCP连接发送。
   7. HTTP的默认方式是使用持续连接，HTTP的客户和服务器也能配置成使用非持续连接。
   8. 往返时间RTT：指一个短分组从客户到服务器然后再返回客户所花费的时间。
   9. 非持续连接的HTTP请求并接受一个HTML文件所需的时间估算，总的响应时间就是两个RTT加上服务器传输HTML文件的时间。一个RTT用于建立TCP连接，一个RTT用于HTTP报文请求与响应，请求和接收一个对象。
   10. 非持续连接的缺点：必须为每一个请求的对象建立和维护一个全新的连接。每一个对象经受两倍RTT的交付时延。
   11. 采用HTTP 1.1持续连接，服务器在发送响应后保持该TCP连接打开。一个完整的Web页面可以用单个持续TCP连接进行传送。如果一条连接经过一定时间间隔仍未被使用，HTTP服务器就关闭该连接。HTTP的默认模式是使用带流水线的持续连接。
   12. HTTP报文：请求报文和响应报文：
       1.  HTTP请求报文：
           1.  第一行叫作请求行，其后继的行叫作首部行。请求行有3哥字段：方法字段、URL字段和HTTP版本字段。
           2.  方法字段可以取：GET、POST、HEAD、PUT和DELETE。绝大部分的HTTP请求报文使用GET方法。
           3.  使用GET方法时实体体为空，而使用POST方法时才使用该实体体（包含用户在表单字段中的输入值）。
           4.  HEAD方法类似于GET方法，但是并不返回请求对象，用于开发者进行调试跟踪。PUT用于上传对象到服务器。DELETE用于删除服务器上的对象。
            ```cpp
            GET /somedir/page.html HTTP/1.1 
            Host: www.someschool.edu   // 指明对象所在的主机
            Connection: close          // 告诉服务器不要麻烦地使用持续连接，要求服务器在发送完被请求地是对象后就关闭这条连接
            User-agent: Mozilla/5.0    // 指明用户代理，即向服务器发送请求的浏览器的类型。
            Accept-language: fr        // 表示用户想得到该对象的法语版本（如果有），否则发送默认版本。
            ```
       2. HTTP响应报文：
          1. 由三部分组成：一个初始状态行，六个首部行，实体体（entity body）。实体体部分是报文的主要部分，即包含了所请求对象本身。状态行有三个字段：协议版本字段、状态码和相应状态信息。
          2. 常见的状态码和相关的短语包括：
             1. 200 OK：请求成功
             2. 301 Moved Permanently：请求的对象已经被永久转移了，新的URL定义在响应报文的Location：首部行中。客户软件将自动获取新的URL。
             3. 400 Bad Request：一个通用差错代码，指示该请求不能被服务器理解。
             4. 404 Not Found：被请求的文档不在服务器上。
             5. 505 HTTP Version Not Supported：服务器不支持请求报文使用的HTTP协议版本。
   ```cpp
   HTTP/1.1 200 OK // 使用HTTP/1.1并且一切正常
   Connection: close // 告诉客户，发送完报文后将关闭该TCP连接
   Data: Tue, 18 Aug 2015 15:44:04 GMT // 首部行指示服务器产生并发送该响应报文的日期和时间。这个时间不是该对象创建或最后一次修改的时间，而是服务器从它的文件系统中检索到该对象，将该对象插入响应报文，并发送该响应报文的时间。
   Server: Apache/2.2.3 (CentOS) // 类似于User-agent，表示由哪台服务器产生
   Last-Modified: Tue. 18 Aug 2015 15:11:03 GMT // 对既可能在本地客户也可能在网络缓存服务器上的对象缓存来说非常重要。
   Content-Length: 6821 // 被发送对象中的字节数
   Content-Type: text/html // 对象类型
   (data data data data data ... ) // 实体体
   ```
    13. HTTP服务器是无状态的。Web站点希望能够识别用户，希望把内容与用户身份联系起来，为此，HTTP使用了cookie，允许站点对用户进行跟踪。
    14. cookie技术有4个组件：
        1.  在HTTP响应报文中的一个cookie首部行。
        2.  在HTTP请求报文中的一个cookie首部行。
        3.  在用户端系统中保留有一个cookie文件，并由用户的浏览器进行管理。
        4.  位于Web站点的一个后端数据库。
    15. Web缓存器（Web cache）也叫代理服务器。Web缓存器有自己的磁盘存储空间，并在存储空间中保存最近请求过的对象的副本。Web缓存器既是服务器又是客户。当它接收浏览器的请求并发回响应时，它是一个服务器。当它向初始服务器发出请求并接收响应时，它是一个客户。
    16. Web缓存器可以大大减少对客户请求的响应时间。Web缓存器能够大大减少一个机构的接入链路到因特网的通信量。
    17. 通过使用内容分发网络CDN，Web缓存器正在因特网中发挥着越来越重要的作用。CDN公司在因特网上安装了许多地理上分散的缓存器，因而使大量流量实现了本地化。
    18. 尽管高速缓存能减少用户感受到的响应时间，但也引入了一个新的问题，即存放在缓存器中的对象副本可能是陈旧的。HTTP协议有一种机制，允许缓存器证实它的对象是新的。条件GET方法：请求报文使用GET方法，并且请求报文中包含一个If-modified-since首部行。
    19. 缓存器在将对象转发到请求的浏览器的同时，也在本地缓存了该对象。缓存器在存储该对象时也存储了最后修改日期。
    20. If-modified-since：条件GET报文告诉服务器，仅当自指定日期之后该对象被修改过，才发送该对象。如果没有被修改，那么返回一个响应报文给缓存器，其中的实体体为empty（否则，浪费带宽，增加响应时间），状态行304 Not Modified，告诉缓存器可以使用该对象，能向请求的浏览器转发缓存器缓存的该对象副本。
   ```cpp
   GET /fruit/kiwi.gif HTTP/1.1
   Host: www.exotiquecuisine.com
   If-modified-since: Wed, 9 Sep 2015 09:23:24
   ```
   ```cpp
   HTTP/1.1 304 Not Modified
   Date: Sat, 10 Oct 2015 15:39:29
   Server: Apache/1.3.0(Unix)
   (empty entity body)
   ```
6.  因特网中的电子邮件：
    1.  电子邮件是一种异步通信媒介。
    2.  因特网电子邮件系统的主要组成部分：用户代理（user agent）、邮件服务器（mail server）、简单邮件传输协议（SMTP）。
    3.  一个典型的邮件发送过程：从发送方的用户代理开始，传输到发送方的邮件服务器，再传输到接收方的邮件服务器，然后在这里被分发到接收方的邮箱中。
    4.  每台邮件服务器上既运行SMTP的客户端也运行SMTP的服务器端。
    5.  客户SMTP在25号端口建立一个到服务器SMTP的TCP连接。SMTP能依赖TCP提供的可靠数据传输无差错地将邮件投递到接收服务器。该客户如果有另外的报文要发送到该服务器，就在该相同的TCP连接上重复这种处理，否则指示TCP关闭连接。
    6.  HTTP主要是一个拉协议（pull protocol），SMTP基本上是一个推协议（push protocol）。
    7.  SMTP要求每个报文采用7比特ASCII码格式。HTTP数据则不受这种限制。
    8.  HTTP把每个对象封装到它自己的HTTP响应报文中，而SMTP则把所有报文对象放在一个报文之中。
    9.  邮件报文格式：From、To、Subject
    10. 用户代理不能使用SMTP得到报文，因为取报文是一个拉操作，而SMTP协议是一个推协议，通过引入一个特殊的邮件访问协议来解决这个难题，该协议将邮件服务器上的报文传送给他的本地PC。流行的邮件访问协议，第三版的邮局协议POP3，因特网邮件访问协议IMAP，以及HTTP。
    11. SMTP用来将邮件从发送方的邮件服务器传输到接收方的邮件服务器；SMTP也用来将邮件从发送方的用户代理传送到发送方的邮件服务器。POP3、IMAP、HTTP这样的邮件访问协议，用来将邮件从接收方的邮件服务器传送到接收方的用户代理。
    12. 用户代理打开了一个到邮件服务器端口110上的TCP连接后，POP3就开始工作了，随着建立TCP连接，POP3按照三个阶段进行工作：特许、事务处理、更新。
    13. 特许阶段：用户代理以明文形式发送用户名和口令以鉴别用户。
    14. 事务处理阶段：用户代理取回报文，同时对报文做删除标记，取消报文删除标记，以及获取邮件的统计信息。
    15. 更新阶段：结束POP3会话，此时，邮件服务器删除那些被标记为删除的报文。
    16. POP3会话过程，对于邮件，可选择使用下载并删除方式，或下载并保留方式。
    17. POP3协议没有给用户提供任何创建远程文件夹并为报文指派文件夹的方法。
    18. IMAP服务器把每个报文与一个文件夹联系起来。与POP3不同，IMAP服务器维护了IMAP会话的用户状态信息。
    19. IMAP具有允许用户代理获取报文某些部分的命令。
    20. 基于Web的电子邮件，用户和远程邮箱之间的通信通过HTTP进行。
7.  DNS：因特网的目录服务
    1.  主机可以使用主机名host-name 或者IP地址来标识。
    2.  路由器喜欢定长的、有着层次结构的IP地址。
    3.  域名系统DNS：进行主机名到IP地址转换，由分层的DNS服务器实现的分布式数据库，一个使得主机能够查询分布式数据库的应用层协议。DNS协议运行在UDP上，使用53号端口。
    4.  除了进行主机名到IP地址的转换外，DNS还提供一些重要的服务：
        1.  主机别名。主机别名比主机规范名更加容易记忆，应用程序可以调用DNS来获得主机别名对应的规范主机名以及主机的IP地址。
        2.  邮件服务器别名。电子邮件应用程序可以调用DNS，对提供的主机名别名进行解析，以获得该主机的规范主机名及IP地址。
        3.  负载分配。DNS也用于在冗余的服务器之间进行负载分配。
    5.  DNS不能只是用一个DNS服务器的集中式设计：
        1.  单点故障。
        2.  通信容量。
        3.  远距离的集中式数据库。时延。
        4.  维护。
        5.  无扩展能力。
    6.  分布式设计：三种类型的DNS服务器：根DNS服务器、顶级域DNS服务器和权威DNS服务器。
    7.  根DNS服务器提供TLD服务器的IP地址。
    8.  顶级DNS服务器提供权威DNS服务器的IP地址。
    9.  权威DNS服务器包含了某个组织机构公共可访问的主机名和IP地址的映射。
    10. 还有另一类重要的DNS服务器，本地DNS服务器，不属于层次结构，但是对DNS层次结构有至关重要作用。每个ISP都有一台本地DNS服务器。
    11. 当主机发出DNS请求时，该请求被发往本地DNS服务器，它起着代理的作用，并将该请求转发到DNS服务器层次结构中。
    12. 任何DNS查询既可以是迭代的也能是递归的。实践中，查询通常遵循：从请求主机到本地DNS服务器的查询是递归的，其余的查询是迭代的。
    13. 为了改善时延性能并减少在因特网上到处传输的DNS报文数量，DNS广泛使用了缓存技术。
    14. 本地DNS服务器可以缓存主机名-IP的映射，然后直接返回。也能够缓存TLD服务器的IP地址，允许本地DNS服务器绕过查询链中的根DNS服务器。因为缓存，除了少数DNS查询以外，根服务器都被绕过了。
    15. 所有DNS服务器存储了资源记录RR，RR提供了主机名到IP地址的映射，每个DNS回答报文包含了一条或多条资源记录。
    16. 资源记录是一个包含了下列字段的四元组：{Name，Value，Type，TTL}
    17. TTL是该记录的生存时间，决定了资源记录应当从缓存中删除的时间。
    18. Name和Value的值取决于Type：
        1.  Type=A，Name是主机名，Value是IP地址。
        2.  Type=NS，Name是个域，Value是个知道如何获得该域中主机IP得知的权威DNS服务器的主机名。
        3.  Type=CNAME，Value是别名为Name的主机对应的规范主机名。
        4.  Type=MX，Value是个别名为Name的邮件服务器的规范主机名。
8. P2P文件分发
   1. 对于客户-服务器体系结构，随着对等方数量的增加，分发时间呈线性增加并且没有界。然而对于P2P体系结构，最小分发时间总是小于客户-服务器体系结构。具有P2P体系结构的应用程序能够是自扩展的。成因是：对等方除了是比特的消费者外还是它们的重新分发者。
   2. 最稀缺优先技术：最稀缺块得到更为迅速的重新分发，其目的是均衡每个块在洪流中的副本数量。
9. 为了应对向分布于全世界的用户分发巨量视频数据的挑战，几乎所有主要的视频流公司都利用内容分发网CDN，CDN管理分布在多个地理位置上的服务器，在它的服务器中存储视频的副本，并且所有试图将每个用户请求定向到一个将提供最好的用户体验的CDN位置。CDN可以是专用CDN也可以是第三方CDN。
10. CDN的两种不同的服务器安置原则：
    1.  深入：通过在遍及全球的接入ISP中部署服务器集群来深入到ISP的接入网中。
    2.  邀请做客：通过在少量关键位置建造大集群来邀请到ISP做客。
11. 集群选择策略：简单策略：指派客户到地理上最近的集群，忽略了时延和可用带宽随因特网路径时间而变化，总是为特定的客户指派相同的集群。
12. 为了基于当前流量条件为客户决定最好的集群，CDN能够对其集群和客户之间的时延和丢包性能执行周期性的实时测量。